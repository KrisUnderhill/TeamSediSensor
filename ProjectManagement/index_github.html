<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK&display=swap" rel="stylesheet">  
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="module">
        //TODO: Move this script to an actual js file not in the html itself
        // Valid fetch command that returns text from zen api
        //fetch("https://api.github.com/zen")
        //    .then(response => response.text().then(text => console.log(text)));
        function main() {
            const url =  "https://api.github.com/repos/krisUnderhill/TeamSediSensor/issues";
            const Init = {
                method: 'GET',
                headers: {
                    Authorization: "token ***Github Auth Token ***" 
                },
                mode: 'cors',
                cache: 'default'
            };
            DrawNavBar()

            fetch(url, Init)
                .then(response => response.json().then(json => DrawGanttTasks(json)));
        }
    
        function DrawNavBar() {
            const header = document.getElementById("navBar");
            header.classList.add("nav-header-container")
            const navMenus = ["Project", "Documentation"]
            // Draw Img
            const logoDiv = document.getElementById("logo");
            logoDiv.classList.add("nav-header-elem");
            const logoLink = document.createElement("a");
            logoLink.href = "index.html";
            const logo = document.createElement("img");
            logo.src = "TSS_Logo.png";
            logo.width = 60;
            logo.height = 80;
            logo.alt = "TSS_Logo, Credit: Moses Yang";
            logoLink.appendChild(logo);
            logoDiv.appendChild(logoLink);
            // Draw Nav Items
            const navDiv = document.getElementById("nav");
            const nav = document.createElement("nav");
            navDiv.appendChild(nav);
            
            navMenus.forEach(menuItem => {
                var navMenuLink = document.createElement("a");
                navMenuLink.href = menuItem + ".html"; //TODO: Fix once there are more than one html
                navMenuLink.innerHTML = menuItem;
                navMenuLink.classList.add("nav-elem");
                nav.appendChild(navMenuLink);
            })
        }

        function DrawGanttTasks(tasksJson) {
        //TODO: Refactor this into a not stupidly long function
            const dispWidth  = 800; // TODO: Make this more general
            const dispHeight = 600;
            console.log(tasksJson);
            d3.select("svg#tasksDisplay")
                .attr("width", dispWidth)
                .attr("height", dispHeight)
            var lastx = 25;
            var lasty = 50;
            var maxNameLen = 200;
            var boxX = 25;
            var boxY = 25;
            let svg; let text;
            let firstIter = true;
            tasksJson.forEach(d => {
                svg = d3.select("svg#tasksDisplay");
                // Draw rectangles + text
                svg.append('rect')
                    .attr('x', lastx)
                    .attr('y', lasty)
                    .attr('width', maxNameLen)
                    .attr('height', boxY)
                    .attr('stroke', 'whitesmoke')
                    .attr('stroke-width', 2)
                text = svg.append('text').text(d.title)
                    .attr('x', lastx + 5)
                    .attr('y', lasty + 20)
                    .attr('font-family', 'Noto Sans HK, sans-serif')
                    .attr('font-size', 12)
                    .attr('fill', "whitesmoke")
                lastx += maxNameLen;
                let done = false; let startWeek = false;
                let day = new Date(); let dayNum = 0; let dateNum = 0;
                while(!done){
                    if(firstIter){ // do all the text on the first iteration
                    // TODO: Decide whether or not to set day based on current day or beginning of tasks
                        if(startWeek){
                            text = svg.append('text').text((day.getMonth() + 1) + '/' + day.getDate())
                                .attr('x', lastx - 15) // Since we take the first loop iteration to set the date
                                                       // it starts drawing boxes, decrement the x position to put 
                                                       // it in the right spots, This solution needs to be improved TODO
                                .attr('y', lasty - 5)
                                .attr('font-family', 'Noto Sans HK, sans-serif')
                                .attr('font-size', 12)
                                .attr('fill', "whitesmoke")
                                .attr("transform", "rotate(-45,"+(lastx-15)+","+(lasty-5)+")")  // AW c'mon js has to have a better way for formatting strings than this TODO
                            // Increment Date
                            day.setDate(dateNum+=7);
                            if(day.getDate() < dateNum){
                                dateNum = day.getDate();
                            }
                        } 
                        else {
                            // Set tracking Numbers
                            dayNum = day.getDay(); 
                            dateNum = day.getDate();
                            // Set Day to Monday to start drawing stuff
                            if(dayNum === 0) { day.setDate(++dateNum) } // sun => mon   
                            else if (dayNum === 1) { /* Mon -- skip*/ }
                            // TODO: Decide whether this should set to next monday or monday before
                            else { day.setDate(dateNum + (8-dayNum)) } // >Mon => Next mon, Test on Tues etc
                            // Set to Draw, aligned dates
                            startWeek = true;
                        }
                    }
                    svg.append('rect')
                        .attr('x', lastx)
                        .attr('y', lasty)
                        .attr('width' , boxX)
                        .attr('height', boxY)
                        .attr('stroke', 'whitesmoke')
                        .attr('stroke-width', 2)
                    lastx += boxX;
                    if(firstIter) {
                        if (day.getMonth() === 0) { // Index at 0 => 11 === Dec
                            firstIter = false;
                            done = true;
                            lastx = 25;
                        }
                    }
                    else{
                        done = true
                        lastx = 25
                    }
                }
                lasty+=boxY;
            });
        }

        //drawSVGDates(svg) {}
    
        main()
    
    </script>
    </head>
<body>
    <div> 
        <header id="navBar">
            <div id="logo"></div>
            <div id="nav"></div>
        </header>
    </div>
    <h1><span>Project Timeline (Gantt)<span></h1>
    <svg id="tasksDisplay"></svg>
</body>
</html>
